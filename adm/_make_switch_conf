#!/usr/bin/env python3

import os
from mflog import get_logger
from mfplugin.manager import PluginsManager

MFDATA_PLUGIN_HOME = os.path.join(os.environ["MFMODULE_RUNTIME_HOME"],
                                  "var", "plugins")
MFMODULE_RUNTIME_HOME = os.environ["MFMODULE_RUNTIME_HOME"]
LOGGER = get_logger("_make_switch_conf")


def make_switch_conf(plugin, num):
    res = []
    rules = plugin.configuration.switch_rules
    plugin_name = os.environ['MFDATA_CURRENT_PLUGIN_NAME']
    plugin_dir = os.environ['MFDATA_CURRENT_PLUGIN_DIR']
    for section in rules:
        tmp = section.replace("switch_rules:", "switch_rules_%i:" % num, 1)
        tmp = tmp.replace('{{MFDATA_CURRENT_PLUGIN_DIR}}', plugin_dir)
        tmp = tmp.replace('{{MFDATA_CURRENT_PLUGIN_NAME}}', plugin_name)
        res.append("[%s]" % tmp)
        for key, value in rules[section].items():
            key_prefix = ""
            # FIXME: hack for python rules
            if section.strip() == "switch_rules:python":
                if ":" not in key:
                    key_prefix = plugin_dir + ":"
            if '/' not in value:
                res.append("%s%s = %s/%s" %
                           (key_prefix, key, plugin_name, value))
            else:
                res.append("%s%s = %s" % (key_prefix, key, value))
    return "\n".join(res)


manager = PluginsManager()
num = 0
print("# GENERATED FILE")
print()
for plugin in manager.plugins.values():
    try:
        plugin.load_full()
    except Exception as e:
        LOGGER.warning("invalid plugin: %s (%s) => ignoring it ; details: %s" %
                       (plugin.name, plugin.home, e))
        continue
    with plugin.plugin_env_context():
        tmp = make_switch_conf(plugin, num)
    if len(tmp) > 0:
        print("# <CONTRIBUTION OF %s PLUGIN>" % plugin.name)
        print()
        print(tmp)
        print()
        print("# </CONTRIBUTION OF %s PLUGIN>" % plugin.name)
        print()
        print()
        num = num + 1
